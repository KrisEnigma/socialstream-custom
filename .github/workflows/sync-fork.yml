name: Sync social_stream fork with upstream

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout socialstream-custom (for custom files)
        uses: actions/checkout@v4
        with:
          path: custom-files
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout social_stream fork
        uses: actions/checkout@v4
        with:
          repository: KrisEnigma/social_stream
          fetch-depth: 0
          path: fork
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      - name: Add upstream remote
        working-directory: fork
        run: git remote add upstream https://github.com/steveseguin/social_stream.git

      - name: Fetch upstream
        working-directory: fork
        run: git fetch upstream main

      - name: Check if upstream is ahead
        working-directory: fork
        id: check
        run: |
          BEHIND=$(git rev-list --count HEAD..upstream/main)
          echo "behind=$BEHIND" >> $GITHUB_OUTPUT
          if [ $BEHIND -gt 0 ]; then
            echo "Upstream has $BEHIND new commits"
          fi

      - name: Merge upstream if ahead
        working-directory: fork
        if: steps.check.outputs.behind != '0'
        run: |
          git merge upstream/main --no-edit || echo "Merge completed or no new commits"

      - name: Copy custom files from socialstream-custom
        run: |
          cp custom-files/kris.js fork/custom.js
          cp custom-files/kris.css fork/custom.css

      - name: Commit and push changes
        working-directory: fork
        run: |
          git add custom.js custom.css
          git diff --cached --quiet || git commit -m "Update custom.js and custom.css from socialstream-custom"
          git push origin main || echo "Nothing new to push"
